<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Streaming | Panel VIP</title>
  <style>
    :root { --bg: #0b0e1a; --card: #161a2f; --brand: #e50914; --text: #ffffff; }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; display: flex; justify-content: center; margin:0; }
    .container { width: 100%; max-width: 550px; }
    .ad-box { width: 100%; min-height: 60px; display: flex; justify-content: center; margin: 15px 0; overflow: hidden; }
    .panel { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid #2a2f4a; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .btn { width: 100%; height: 60px; background: var(--brand); border: none; color: #fff; font-weight: 800; border-radius: 12px; cursor: pointer; font-size: 18px; transition: 0.3s; }
    .btn:active { transform: scale(0.98); }
    .status { margin-top: 15px; text-align: center; font-size: 14px; color: #b9bfd6; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; }
    .email-card { background: white; color: black; margin-top: 20px; border-radius: 12px; overflow: hidden; animation: fadeIn 0.5s; }
    .email-header { background: #10132b; color: white; padding: 12px; font-size: 14px; border-bottom: 2px solid var(--brand); }
    .email-body { padding: 15px; font-size: 14px; }
    .email-body * { max-width: 100% !important; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div class="container">
  <h1 style="text-align:center; font-size: 24px;">üöÄ SUPER <span>STREAMING</span></h1>

  <div class="ad-box">
    <script type="text/javascript">
      atOptions = { 'key' : 'cceca146ecc06005e59390960db3af7f', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
    </script>
    <script type="text/javascript" src="https://www.highperformanceformat.com/cceca146ecc06005e59390960db3af7f/invoke.js"></script>
  </div>

  <div class="panel">
    <button class="btn" id="btnBuscar">üì© BUSCAR C√ìDIGO NUEVO</button>
    <div id="status" class="status">Estado: Esperando orden...</div>
    <div id="result"></div>
  </div>

  <div class="ad-box">
    <script async="async" data-cfasync="false" src="https://pl28653744.effectivegatecpm.com/8a7799c7f525d405dcfb1471a70d0b70/invoke.js"></script>
    <div id="container-8a7799c7f525d405dcfb1471a70d0b70"></div>
  </div>
</div>

<script>
  // L√ìGICA DE B√öSQUEDA AISLADA
  document.getElementById('btnBuscar').onclick = async function() {
    const status = document.getElementById("status");
    const result = document.getElementById("result");
    
    status.innerHTML = "‚è≥ Conectando con Railway...";
    result.innerHTML = "";

    try {
      // Intentamos la petici√≥n con un timeout de 15 segundos
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000);

      const response = await fetch("/api/emails", { 
        signal: controller.signal,
        cache: 'no-store'
      });
      
      clearTimeout(timeoutId);

      if (!response.ok) throw new Error("Error en el servidor (" + response.status + ")");

      const data = await response.json();

      if (!data.emails || data.emails.length === 0) {
        status.innerHTML = "‚è≥ Conectado: No hay correos nuevos.";
        return;
      }

      // FILTRO NETFLIX
      const filtrados = data.emails.filter(e => {
        const contenido = (e.subject + e.html).toLowerCase();
        return contenido.includes("netflix");
      });

      if (filtrados.length === 0) {
        status.innerHTML = "‚è≥ No se hallaron c√≥digos de Netflix.";
        return;
      }

      filtrados.forEach(e => {
        const card = document.createElement("div");
        card.className = "email-card";
        card.innerHTML = `
          <div class="email-header"><b>${e.subject}</b></div>
          <div class="email-body">${e.html}</div>
        `;
        result.appendChild(card);
      });

      status.innerHTML = "‚úÖ ¬°C√≥digos actualizados!";

    } catch (err) {
      console.error(err);
      if (err.name === 'AbortError') {
        status.innerHTML = "‚ùå Error: El servidor tard√≥ mucho en responder.";
      } else {
        status.innerHTML = "‚ùå Error de conexi√≥n: Revisa Railway.";
      }
    }
  };
</script>

</body>
</html>
